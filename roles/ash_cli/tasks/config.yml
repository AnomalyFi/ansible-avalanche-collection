# SPDX-License-Identifier: BSD-3-Clause
# Copyright (c) 2022-2023, E36 Knots
---
- name: Initialize the default Ash CLI configuration
  command:
    cmd: ash conf init --config {{ ash_cli_conf_dir }}/default.yml
    creates: "{{ ash_cli_conf_dir }}/default.yml"

- block:
    - name: Initialize minimal Ash CLI configuration
      command:
        cmd: ash conf init --config {{ ash_cli_conf_dir }}/minimal.yml
        creates: "{{ ash_cli_conf_dir }}/minimal.yml"

    - name: Add local network P-Chain configuration
      blockinfile:
        path: "{{ ash_cli_conf_dir }}/minimal.yml"
        block: |
          - name: local
            subnets:
            - id: "{{ avalanche_primary_network_id }}"
              controlKeys: []
              threshold: 0
              blockchains:
              - id: "{{ avalanche_primary_network_id }}"
                name: P-Chain
                vmID: "{{ avalanche_primary_network_id }}"
                vmType: PlatformVM
                rpcUrl: {{ avalanche_pchain_local_url }}
        insertafter: "avalancheNetworks:"

    - name: Get C-Chain and X-Chain chain and VM IDs
      ash.avalanche.ash_cmd:
        command: "avalanche subnet info {{ avalanche_primary_network_id }}"
        options:
          config: "{{ ash_cli_conf_dir }}/minimal.yml"
      register: primary_network_info

    - name: Complete local network configuration
      blockinfile:
        path: "{{ ash_cli_conf_dir }}/default.yml"
        block: |
          - name: local
            subnets:
            - id: "{{ avalanche_primary_network_id }}"
              controlKeys: []
              threshold: 0
              blockchains:
              - id: "{{ avalanche_primary_network_id }}"
                name: P-Chain
                vmID: "{{ avalanche_primary_network_id }}"
                vmType: PlatformVM
                rpcUrl: {{ avalanche_pchain_local_url }}
              - id: "{{ (primary_network_info.output | json_query("blockchains[?name=='C-Chain']"))[0].id }}"
                name: C-Chain
                vmID: "{{ (primary_network_info.output | json_query("blockchains[?name=='C-Chain']"))[0].vmID }}"
                vmType: PlatformVM
                rpcUrl: {{ avalanche_cchain_local_url }}
              - id: "{{ (primary_network_info.output | json_query("blockchains[?name=='X-Chain']"))[0].id }}"
                name: X-Chain
                vmID: "{{ (primary_network_info.output | json_query("blockchains[?name=='X-Chain']"))[0].vmID }}"
                vmType: PlatformVM
                rpcUrl: {{ avalanche_xchain_local_url }}
        insertafter: "avalancheNetworks:"
  when: avalanche_network_id == "local"
